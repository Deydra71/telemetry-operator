---
- job:
    name: telemetry-operator-multinode-autoscaling
    parent: podified-multinode-edpm-deployment-crc
    dependencies: ["openstack-k8s-operators-content-provider"]
    description: |
      Deploy OpenStack with Autoscaling features enabled
    vars:
      cifmw_edpm_prepare_timeout: 60
      pre_deploy:
        - name: Create COO subscription
          source: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/openstack-k8s-operators/telemetry-operator'].src_dir }}/ci/create-coo-subscription.yaml"
          type: playbook
      cifmw_install_yamls_vars:
        BMO_SETUP: false
      cifmw_edpm_prepare_kustomizations:
        - apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          namespace: openstack
          patches:
          - patch: |-
              apiVersion: core.openstack.org/v1beta1
              kind: OpenStackControlPlane
              metadata:
                name: unused
              spec:
                heat:
                  enabled: true
                telemetry:
                  enabled: true
                  template:
                    metricStorage:
                      enabled: true
                      monitoringStack:
                        alertingEnabled: false
                    autoscaling:
                      enabled: true
            target:
              kind: OpenStackControlPlane

- job:
    name: telemetry-operator-multinode-autoscaling-tempest
    parent: telemetry-operator-multinode-autoscaling
    vars:
      cifmw_tempest_container: openstack-tempest-all
      cifmw_tempest_tempestconf_profile:
        overrides:
            compute-feature-enabled.vnc_console: true
            validation.run_validation: true
            # NOTE(gibi): This is a WA to force the publicURL as otherwise
            # tempest gets configured with adminURL and that causes test
            # instability.
            identity.v3_endpoint_type: public
            identity.v2_admin_endpoint_type: public
            service_available.ceilometer: true
            service_available.sg_core: true
            telemetry.sg_core_service_url: "ceilometer.openstack.svc.cluster.local:3000"
     # NOTE(efoley): First step is to get ANY tempest jobs running to confirm a working config
      cifmw_tempest_tests_allowed: # need to see ciframwework roles that use these vars, to see how to enable telemetry
        - telemetry_tempest_plugin.scenario
        - telemetry_tempest_plugin.aodh
      cifmw_tempest_tests_skipped: []

- project:
    name: openstack-k8s-operators/telemetry-operator
    templates:
      - podified-multinode-edpm-pipeline
    github-check:
      jobs:
        - telemetry-operator-multinode-autoscaling-tempest
